<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style>
			body {
			    font-family: Arial, sans-serif;
			    margin: auto;
			    padding: 20px;
			    justify-content: center;
			    align-items: center;
			    background-color: #f0f0f0;
				display: flex;
				flex-direction: column;
			}

			.container {
				width: 100%;
			    max-width: 400px;
			    background-color: #fff;
			    padding: 20px;
			    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
			    border-radius: 8px;
				text-align: left;
			}

			input[type='text'],
			input[type='password'] {
			    width: 80%;
			    padding: 10px;
			    margin: 10px 0px;
			    border: 1px solid #ccc;
			    border-radius: 4px;
			    font-size: 16px;
			}

			button, input[type='submit'] {
			    background-color: #4CAF50;
			    color: white;
			    padding: 10px 20px;
			    border: none;
			    border-radius: 4px;
			    cursor: pointer;
			    font-size: 16px;
			}

			button, input[type='submit']:hover {
			    background-color: #45a049;
			}

			table { border-collapse: collapse; width: 100%; }
			table, th, td { border:1px solid black; }
		</style>
		<script>
			function formatMeshID(e) { 
				var r = e.target.value.replace(/[^a-fA-F0-9]/g, ''); 
				e.target.value = r.match(/.{1,2}/g).join('-'); 
			} 
			
			function togglePassword(id) { 
				var x = document.getElementById(id); 
				if (x.type === 'password') { 
					x.type = 'text'; 
				} else { 
					x.type = 'password'; 
				} 
			}
			
			// Função para buscar o JSON do servidor
			function fetchJsonData() {
				fetch('/get_mesh_data') // Alterar a URL conforme necessário
					.then(response => response.json())
					.then(data => buildTable(data))
					.catch(error => console.error('Error fetching data:', error));
			}

			// Função para construir a tabela a partir do JSON
			function buildTable(data) {
				let table = document.getElementById('meshTable');
				table.innerHTML = '<tr><th>Node</th><th>Parent</th><th>Layer</th></tr>';
				parseNode(data, null, table);
			}

			// Função recursiva para percorrer o JSON e preencher a tabela
			function parseNode(node, parent, table) {
				if (node) {
					let row = table.insertRow();
					row.insertCell(0).textContent = node.name;
					row.insertCell(1).textContent = parent ? parent.name : 'None';
					row.insertCell(2).textContent = node.layer;
					if (node.children) {
						node.children.forEach(child => parseNode(child, node, table));
					}
				}
			}

			// Função para enviar a URL do firmware e acompanhar a atualização
			function sendFirmwareURL() {
				const url = document.getElementById('firmware_url').value;
				const status = document.getElementById('update_status');
				const socket = new WebSocket('ws://<ESP32-IP-ADDRESS>/update');

				socket.onopen = function() {
					status.textContent = 'Update Started...';
					socket.send(JSON.stringify({ url: url }));
				};

				socket.onmessage = function(event) {
					const data = JSON.parse(event.data);
					if (data.complete) {
						status.textContent = 'Update Complete!';
						socket.close();
					}
				};

				socket.onerror = function(error) {
					console.error('WebSocket Error: ', error);
					status.textContent = 'Update Failed!';
				};

				socket.onclose = function() {
					console.log('WebSocket Closed');
				};
			}

			// Chama a função de busca de JSON após o carregamento da página
			document.addEventListener('DOMContentLoaded', fetchJsonData);
		</script>
	</head>

	<body>
		<br />
		<div class="container">
			<h2>Device Info</h2>
			<p>Root MAC address: 08:d1:f9:dd:80:9c</p>
		</div>
		<br />
		<div class="container">
			<form action="/set_wifi" method="post">
                <h2>Configure WiFi Router</h2>
				<label for="router_ssid">Router SSID:</label><br />
				<input type="text" id="router_ssid" name="router_ssid" value="Roger" required /><br />
				<label for="router_password">Router Password:</label><br />
				<input type="password" id="router_password" name="router_password" value="fatality" required /><br />
				<input type="checkbox" onclick='togglePassword("router_password")' /> Show Password<br />
				<br /><br />
                <h2>Configure Mesh Network</h2>
				<label for="mesh_id">Mesh ID:</label><br />
                <!-- NAO PODE SEPARADOR ':' NO MESH_ID, POIS O FORM CODIFICA DIFERENTE AO FAZER POST -->
				<input type="text" id="mesh_id" name="mesh_id" value="77-77-77-77-77-77" required oninput="formatMeshID(event)" maxlength="17" /><br />
				<label for="mesh_password">Mesh Password:</label><br />
				<input type="password" id="mesh_password" name="mesh_password" value="MAP_PASSWD" required /><br />
				<input type="checkbox" onclick='togglePassword("mesh_password")' /> Show Password<br />
				<br />
				<input type="submit" value="Update Config" />
			</form>
		</div>
		<br />
		<!-- Container para atualização do firmware -->
		<div class="container">
			<h2>Update Firmware</h2>
			<label for="firmware_url">Firmware URL:</label><br />
			<input type="text" id="firmware_url" name="firmware_url" required /><br />
			<button onclick="sendFirmwareURL()">Update Firmware</button>
			<p id="update_status">Update Status: Not Started</p>
		</div>
		<br />
		<div class="container">
			<h3>Nodes in Mesh Network</h3>
			<button onclick="openTree()">Open Tree View</button>
			<button onclick="fetchJsonData()">Refresh Mesh</button>
			<br /><br />
			<table id="meshTable">
				<!-- Tabela será preenchida dinamicamente -->
			</table>
		</div>
		<script>
			function openTree() {
				window.open('mesh_tree', '_blank');
			}
		</script>
	</body>
</html>
